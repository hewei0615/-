```html
<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é±¼é›å°ç¬º</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'STKaiti', 'KaiTi', 'SimKai', serif;
      }

      :root {
        --primary: #7f9e8a;
        --secondary: #cde0d5;
        --accent: #4b876d;
        --text: #3c4d43;
        --light: #f0f5f1;
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        --notification-red: #c62828;
        --header-gradient: linear-gradient(-45deg, #a8d8b9, #87bfa0, #67a687, #4b876d);
        --receiver-bubble-gradient: linear-gradient(to right, rgba(205, 224, 213, 0.85), rgba(255, 255, 255, 0.85));
        --sender-bubble-gradient: linear-gradient(to left, rgba(127, 158, 138, 0.85), rgba(75, 135, 109, 0.85));
        --focus-shadow: rgba(127, 158, 138, 0.3);
        --random-quote-bg: rgba(240, 245, 241, 0.7);
        --breathe-shadow: rgba(75, 135, 109, 0.2);
      }

      @keyframes flowGradient {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      @keyframes breathe {
        0%,
        100% {
          transform: scale(1);
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        50% {
          transform: scale(1.04);
          box-shadow: 0 4px 16px var(--breathe-shadow);
        }
      }

      body {
        /* Background set by JS */
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        color: var(--text);
        transition: background 0.5s ease;
      }

      .container {
        width: 95%;
        max-width: 500px;
        height: 90vh;
        background-color: var(--light);
        border-radius: 12px;
        box-shadow: var(--shadow);
        overflow: hidden;
        position: relative;
        display: flex;
        flex-direction: column;
      }

      .header {
        color: var(--light);
        padding: 16px;
        text-align: center;
        box-shadow: var(--shadow);
        position: relative;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--header-gradient);
        background-size: 400% 400%;
        animation: flowGradient 15s ease infinite;
      }

      .header h1 {
        font-size: 1.5rem;
        letter-spacing: 3px;
      }

      #theme-toggle-button {
        position: absolute;
        top: 50%;
        right: 16px;
        transform: translateY(-50%);
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.5);
        color: white;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        backdrop-filter: blur(2px);
      }

      #theme-toggle-button:hover {
        background: rgba(255, 255, 255, 0.4);
        transform: translateY(-50%) scale(1.1);
      }

      .contacts-page {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        background-position: center;
        background-size: cover;
        display: flex;
        flex-direction: column;
        transition: background 0.5s ease;
      }

      .contact-list {
        list-style: none;
        flex-shrink: 0;
      }

      .contact-item {
        background: rgba(255, 255, 255, 0.85);
        margin: 12px 0;
        padding: 16px;
        border-radius: 8px;
        box-shadow: var(--shadow);
        display: flex;
        align-items: center;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(3px);
        border-left: none;
      }

      .contact-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        background: rgba(255, 255, 255, 0.95);
      }

      .contact-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 5px;
        height: 100%;
        background: var(--header-gradient);
        background-size: 400% 400%;
        animation: flowGradient 15s ease infinite reverse;
        z-index: 1;
      }

      .avatar {
        width: 65px;
        height: 65px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 16px;
        position: relative;
        border: 2px solid var(--accent);
        animation: breathe 5s ease-in-out infinite;
      }

      .avatar-wrapper {
        position: relative;
        flex-shrink: 0;
      }

      .avatar::after {
        content: '';
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 1px solid var(--light);
        opacity: 0.3;
      }

      .contact-info {
        flex: 1;
        overflow: hidden;
      }

      .contact-name-wrapper {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
      }

      .contact-name {
        font-size: 1.2rem;
        font-weight: bold;
      }

      .new-badge {
        background-color: var(--notification-red);
        color: white;
        font-size: 0.7rem;
        font-weight: bold;
        padding: 2px 6px;
        border-radius: 8px;
        display: none;
      }

      .contact-item.new .new-badge {
        display: inline-block;
      }

      .last-message {
        font-size: 0.8rem;
        color: var(--primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
      }

      .random-image-container {
        margin-top: 20px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.6);
        border-radius: 8px;
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        align-items: center;
        backdrop-filter: blur(2px);
        cursor: pointer;
      }

      #randomImage {
        max-width: 100%;
        height: auto;
        border-radius: 6px;
        display: block;
      }

      .random-quote {
        color: var(--accent);
        font-size: 0.9rem;
        padding: 8px 12px;
        margin-top: 10px;
        text-align: center;
        font-style: italic;
        background-color: var(--random-quote-bg);
        border-radius: 4px;
        width: 100%;
        transition: opacity 0.5s ease;
      }

      .chat-page {
        flex: 1;
        display: flex;
        flex-direction: column;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--light);
        transform: translateX(100%);
        transition: transform 0.4s ease;
        z-index: 20;
      }

      .chat-page.active {
        transform: translateX(0);
      }

      .chat-header {
        color: var(--light);
        padding: 16px;
        display: flex;
        align-items: center;
        box-shadow: var(--shadow);
        position: relative;
        background: var(--header-gradient);
        background-size: 400% 400%;
        animation: flowGradient 15s ease infinite;
      }

      .back-button {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: var(--light);
        font-size: 1.8rem;
        font-weight: bold;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        border: none;
        z-index: 10;
        line-height: 1;
        padding-bottom: 4px;
        background: var(--header-gradient);
        background-size: 400% 400%;
        animation: flowGradient 15s ease infinite;
      }

      .back-button:hover {
        transform: translateY(-50%) scale(1.1);
      }

      .chat-title {
        font-size: 1.3rem;
        letter-spacing: 1px;
        flex: 1;
        text-align: center;
        padding: 0 60px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .chat-title .chat-avatar {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--light);
        margin-right: 10px;
        animation: breathe 5s ease-in-out infinite;
      }

      .message-container {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        background-position: center;
        background-size: cover;
        transition: background 0.5s ease;
      }

      .message-list {
        list-style: none;
      }

      .message-item {
        display: flex;
        max-width: 80%;
        margin-bottom: 16px;
        animation: fadeIn 0.5s ease;
        position: relative;
        user-select: none;
        transition: all 0.3s ease;
      }

      /* åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†æ ·å¼ */
      .delete-confirm-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .delete-confirm-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .delete-confirm-dialog {
        background: var(--light);
        border-radius: 12px;
        padding: 24px;
        max-width: 320px;
        width: 90%;
        box-shadow: var(--shadow);
        text-align: center;
        transform: scale(0.8);
        transition: transform 0.3s ease;
      }

      .delete-confirm-overlay.show .delete-confirm-dialog {
        transform: scale(1);
      }

      .delete-confirm-title {
        font-size: 1.2rem;
        font-weight: bold;
        color: var(--text);
        margin-bottom: 12px;
      }

      .delete-confirm-message {
        color: var(--primary);
        margin-bottom: 20px;
        font-size: 0.95rem;
        line-height: 1.4;
      }

      .delete-confirm-buttons {
        display: flex;
        gap: 12px;
        justify-content: center;
      }

      .delete-confirm-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 80px;
      }

      .delete-confirm-btn.cancel {
        background: var(--secondary);
        color: var(--text);
      }

      .delete-confirm-btn.cancel:hover {
        background: var(--primary);
        color: white;
      }

      .delete-confirm-btn.confirm {
        background: var(--notification-red);
        color: white;
      }

      .delete-confirm-btn.confirm:hover {
        background: #a52a2a;
        transform: scale(1.05);
      }

      /* æ–°æ¶ˆæ¯å¼¹çª—æ ·å¼ - ä»¿QQ/å¾®ä¿¡é•¿æ–¹å½¢è®¾è®¡ */
      .message-notification {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(-20px);
        background: var(--light);
        border: 1px solid var(--primary);
        border-radius: 8px;
        padding: 0;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
        z-index: 2000;
        width: 320px;
        min-height: 72px;
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        pointer-events: none;
        font-family: 'STKaiti', 'KaiTi', 'SimKai', serif;
        overflow: hidden;
      }

      .message-notification.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
        pointer-events: auto;
      }

      .message-notification::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: var(--primary);
      }

      .notification-header {
        background: var(--primary);
        color: white;
        padding: 8px 12px;
        font-size: 0.85rem;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .notification-body {
        padding: 12px;
        display: flex;
        align-items: center;
        gap: 12px;
        background: var(--light);
      }

      .notification-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        object-fit: cover;
        border: 1px solid var(--secondary);
        flex-shrink: 0;
        background: var(--secondary);
      }

      .notification-content {
        flex: 1;
        min-width: 0;
      }

      .notification-name {
        font-weight: bold;
        color: var(--text);
        font-size: 0.95rem;
        margin-bottom: 4px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .notification-text {
        color: var(--primary);
        font-size: 0.85rem;
        line-height: 1.4;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        opacity: 0.8;
      }

      .notification-close {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        font-size: 16px;
        padding: 0;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.2s ease;
      }

      .notification-close:hover {
        background-color: rgba(255, 255, 255, 0.2);
      }

      /* å½“å‰è”ç³»äººæ¶ˆæ¯æ ·å¼ */
      .message-notification.current-contact .notification-body {
        justify-content: center;
        text-align: center;
        padding: 16px 12px;
      }

      .message-notification.current-contact .notification-current-text {
        font-size: 1rem;
        color: var(--primary);
        font-weight: bold;
      }

      /* å“åº”å¼è®¾è®¡ */
      @media (max-width: 480px) {
        .message-notification {
          right: 10px;
          width: calc(100vw - 20px);
          max-width: 320px;
        }
      }

      .message-item.sender {
        margin-left: auto;
        flex-direction: row-reverse;
      }

      .message-item.receiver {
        margin-right: auto;
        flex-direction: row;
      }

      .sender-badge {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        font-weight: bold;
        color: white;
        flex-shrink: 0;
        margin: 0 8px;
        box-shadow: var(--shadow);
      }

      .sender-badge.jin {
        background-color: var(--accent);
      }

      .sender-badge.yu {
        background-color: var(--primary);
      }

      .message-content-wrapper {
        display: flex;
        flex-direction: column;
      }

      .sender .message-content-wrapper {
        align-items: flex-end;
      }

      .receiver .message-content-wrapper {
        align-items: flex-start;
      }

      .message-content {
        padding: 12px 16px;
        border-radius: 18px;
        position: relative;
        box-shadow: var(--shadow);
        font-size: 1.1rem;
        backdrop-filter: blur(2px);
      }

      .receiver .message-content {
        background: var(--receiver-bubble-gradient);
        border-bottom-left-radius: 2px;
      }

      .sender .message-content {
        background: var(--sender-bubble-gradient);
        color: white;
        border-bottom-right-radius: 2px;
      }

      .message-time {
        font-size: 0.7rem;
        margin-top: 4px;
        opacity: 0.7;
        padding: 0 8px;
      }

      .input-container {
        padding: 12px;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        border-top: 1px solid var(--secondary);
        box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
        backdrop-filter: blur(3px);
      }

      .message-input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid var(--secondary);
        border-radius: 24px;
        font-size: 1.1rem;
        outline: none;
        transition: all 0.3s ease;
        background: var(--light);
      }

      .message-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 8px var(--focus-shadow);
      }

      .send-button {
        width: 48px;
        height: 48px;
        border: none;
        border-radius: 50%;
        color: white;
        margin-left: 8px;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.5rem;
        transition: all 0.3s ease;
        box-shadow: var(--shadow);
        background: var(--header-gradient);
        background-size: 400% 400%;
        animation: flowGradient 15s ease infinite;
      }

      .send-button:hover {
        transform: scale(1.05);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (max-width: 480px) {
        .container {
          height: 95vh;
          width: 98%;
          border-radius: 10px;
        }
        .header h1 {
          font-size: 1.3rem;
        }
        .contact-item {
          padding: 12px;
        }
        .avatar {
          width: 55px;
          height: 55px;
        }
        .back-button {
          width: 36px;
          height: 36px;
          font-size: 1.7rem;
        }
        .chat-title .chat-avatar {
          width: 32px;
          height: 32px;
        }
        .chat-title {
          font-size: 1.2rem;
          padding: 0 50px;
        }
        .message-content {
          font-size: 1rem;
          padding: 10px 14px;
        }
        .message-input {
          padding: 10px 14px;
          font-size: 1rem;
        }
        .send-button {
          width: 42px;
          height: 42px;
          font-size: 1.3rem;
        }
        .sender-badge {
          width: 26px;
          height: 26px;
          font-size: 0.8rem;
        }
      }
    </style>
  </head>
  <body>
    <div id="data-source" style="display: none">$1</div>

    <div class="container">
      <div class="header">
        <h1 id="mainTitle">é±¼é›å°ç¬º</h1>
        <button id="theme-toggle-button">ğŸ¨</button>
      </div>

      <div class="contacts-page" id="contactsPage">
        <ul class="contact-list" id="contactList"></ul>
        <div class="random-image-container" id="randomImageContainer">
          <img id="randomImage" src="" alt="å±±æ°´ç”»å·" />
          <p id="randomQuote" class="random-quote"></p>
        </div>
      </div>

      <div class="chat-page" id="chatPage">
        <div class="chat-header">
          <button class="back-button" id="backButton">&lt;</button>
          <div class="chat-title" id="chatTitle"></div>
        </div>
        <div class="message-container" id="messageContainer">
          <ul class="message-list" id="messageList"></ul>
        </div>
        <div class="input-container">
          <input type="text" class="message-input" id="messageInput" placeholder="é¸¿é›ä¼ ä¹¦" />
          <button class="send-button" id="sendButton">â†—</button>
        </div>
      </div>
    </div>

    <!-- åˆ é™¤ç¡®è®¤å¯¹è¯æ¡† -->
    <div class="delete-confirm-overlay" id="deleteConfirmOverlay">
      <div class="delete-confirm-dialog">
        <div class="delete-confirm-title">åˆ é™¤æ¶ˆæ¯</div>
        <div class="delete-confirm-message" id="deleteConfirmMessage">ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ</div>
        <div class="delete-confirm-buttons">
          <button class="delete-confirm-btn cancel" id="deleteCancelBtn">å–æ¶ˆ</button>
          <button class="delete-confirm-btn confirm" id="deleteConfirmBtn">åˆ é™¤</button>
        </div>
      </div>
    </div>

    <!-- æ–°æ¶ˆæ¯å¼¹çª— -->
    <div class="message-notification" id="messageNotification">
      <div id="notificationContent"></div>
    </div>

    <script>
      const themes = [
        {
          name: 'default',
          colors: {
            '--primary': '#7f9e8a',
            '--secondary': '#cde0d5',
            '--accent': '#4b876d',
            '--text': '#3c4d43',
            '--light': '#f0f5f1',
            '--header-gradient': 'linear-gradient(-45deg, #a8d8b9, #87bfa0, #67a687, #4b876d)',
            '--receiver-bubble-gradient':
              'linear-gradient(to right, rgba(205, 224, 213, 0.85), rgba(255, 255, 255, 0.85))',
            '--sender-bubble-gradient': 'linear-gradient(to left, rgba(127, 158, 138, 0.85), rgba(75, 135, 109, 0.85))',
            '--focus-shadow': 'rgba(127, 158, 138, 0.3)',
            '--random-quote-bg': 'rgba(240, 245, 241, 0.7)',
            '--breathe-shadow': 'rgba(75, 135, 109, 0.2)',
          },
          backgrounds: {
            body: 'url(\'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23f0f5f1"/><path d="M0,50 Q25,30 50,50 T100,50" stroke="%23cde0d5" stroke-width="2" fill="none"/></svg>\')',
            contacts: "url('https://files.catbox.moe/sebp8s.jpg')",
            messages: "url('https://files.catbox.moe/smtv5t.png')",
          },
        },
        {
          name: 'brown',
          colors: {
            '--primary': '#8d6e63',
            '--secondary': '#d7ccc8',
            '--accent': '#5d4037',
            '--text': '#4e342e',
            '--light': '#efebe9',
            '--header-gradient': 'linear-gradient(-45deg, #e0cda1, #8d6e63, #8c7b75, #5d4037)',
            '--receiver-bubble-gradient':
              'linear-gradient(to right, rgba(215, 204, 200, 0.8), rgba(255, 255, 255, 0.8))',
            '--sender-bubble-gradient': 'linear-gradient(to left, rgba(141, 110, 99, 0.8), rgba(161, 136, 127, 0.8))',
            '--focus-shadow': 'rgba(141, 110, 99, 0.3)',
            '--random-quote-bg': 'rgba(239, 235, 233, 0.7)',
            '--breathe-shadow': 'rgba(93, 64, 55, 0.25)',
          },
          backgrounds: {
            body: 'url(\'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23efebe9"/><path d="M0,50 Q25,30 50,50 T100,50" stroke="%23d7ccc8" stroke-width="2" fill="none"/></svg>\')',
            contacts: "url('https://files.catbox.moe/4kb7h3.jpg')",
            messages: "url('https://files.catbox.moe/gzvywe.png')",
          },
        },
        {
          name: 'blue',
          colors: {
            '--primary': '#6495ED',
            '--secondary': '#ADD8E6',
            '--accent': '#4682B4',
            '--text': '#2c3e50',
            '--light': '#F0F8FF',
            '--header-gradient': 'linear-gradient(-45deg, #a0c4ff, #87CEEB, #6495ED, #4682B4)',
            '--receiver-bubble-gradient':
              'linear-gradient(to right, rgba(176, 224, 230, 0.8), rgba(240, 248, 255, 0.8))',
            '--sender-bubble-gradient': 'linear-gradient(to left, rgba(100, 149, 237, 0.8), rgba(135, 206, 235, 0.8))',
            '--focus-shadow': 'rgba(70, 130, 180, 0.3)',
            '--random-quote-bg': 'rgba(240, 248, 255, 0.7)',
            '--breathe-shadow': 'rgba(70, 130, 180, 0.25)',
          },
          backgrounds: {
            body: 'url(\'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23F0F8FF"/><path d="M0,50 Q25,30 50,50 T100,50" stroke="%23ADD8E6" stroke-width="2" fill="none"/></svg>\')',
            contacts: "url('https://files.catbox.moe/veik28.jpg')",
            messages: "url('https://files.catbox.moe/lnu989.jpg')",
          },
        },
      ];

      let currentThemeIndex = 0;
      let lastDataSourceContent = '';
      let currentContact = null;
      let contactsData = [];
      let previousMessages = {};
      let tempMessages = {};

      const quotes = [
        'ç‘¾ï¼š{{user}}å¤§äººæ…§çœ¼è¯†ç ï¼Œæ­¤ç”»é£éª¨ç¡®æœ‰å¯å–ä¹‹å¤„ã€‚',
        'ç‘œï¼šå¤§äººçœ‹çš„æ˜¯å±±æ°´ï¼Œå¯æ€€ç‘œçœ‹çš„ï¼Œä»æ¥éƒ½åªæ˜¯æ‚¨ã€‚',
        'ç‘¾ï¼šå¤©è‰²å·²æ™šï¼Œå¤§äººèµç”»ä¹‹ä½™ï¼Œè¿˜è¯·æ³¨æ„æ·»è¡£ï¼Œåˆ‡è«ç€å‡‰ã€‚',
        'ç‘œï¼šå…„é•¿åªä¼šè®©æ‚¨æ·»è¡£ï¼Œä½†ä»–å´ä¸çŸ¥ï¼Œæ€€ç‘œçš„å¿ƒï¼Œå¯ä»¥ä¸ºæ‚¨ç‡ƒèµ·ä¸€ç‚‰ç«ã€‚',
        'ç‘¾ï¼šè‹¥å¤§äººå–œæ¬¢ï¼Œæ€€ç‘¾å¯ä¸ºæ‚¨å¯»æ¥æ›´å¤šæ­¤ç­‰é£æ ¼çš„ç”»ä½œã€‚',
        'ç‘œï¼šå…„é•¿æ‰¾æ¥çš„ç”»å†å¤šï¼Œä¹Ÿä¸è¿‡æ˜¯å‡¡å“ï¼Œæ€€ç‘œçš„ç”»ï¼Œæ¯ä¸€ç¬”éƒ½è˜¸ç€å¯¹æ‚¨çš„æ€å¿µã€‚',
        'ç‘¾ï¼šæ­¤ç”»æ„å¢ƒï¼Œä»¤æ€€ç‘¾æƒ³èµ·ã€Šå¤«èŒƒã€‹ä¸­çš„â€˜é™å¿ƒâ€™äºŒå­—ã€‚',
        'ç‘œï¼šå…„é•¿çš„å¿ƒé™å¦‚æ­¢æ°´ï¼Œæˆ‘çš„å¿ƒå´ä¸ºæ‚¨æ€èµ·æ»”å¤©å·¨æµªã€‚',
        'ç‘¾ï¼šå¼Ÿå¼Ÿä¹Ÿæ“…ä¸¹é’ï¼Œä¸çŸ¥ä»–è§äº†æ­¤ç”»ï¼Œä¼šä½œä½•æ„Ÿæƒ³ã€‚',
        'ç‘œï¼šæˆ‘èƒ½æœ‰ä»€ä¹ˆæ„Ÿæƒ³ï¼Ÿæ— éæ˜¯å†çœ‹ä¸€æ¬¡å…„é•¿å°†ä¸–é—´ç¾å¥½å ä¸ºå·±æœ‰ï¼ŒåŒ…æ‹¬â€¦æ‚¨çš„ç›®å…‰ã€‚',
        'ç‘¾ï¼šèƒ½ä¸ºå¤§äººåˆ†å¿§ï¼Œæ˜¯æ€€ç‘¾çš„æœ¬åˆ†ï¼Œä¹Ÿæ˜¯è£å¹¸ã€‚',
        'ç‘œï¼šèƒ½ä¸ºå¤§äººè§£ä¹ï¼Œæ˜¯æ€€ç‘œçš„æœ¬èƒ½ï¼Œä¹Ÿæ˜¯æ¸´æœ›ã€‚',
        'ç‘¾ï¼šè¿™å±±é—´è™½æœ‰é›¾æ°”ï¼Œä½†è¿œæ–¹æ—¥å…‰æ˜åªšï¼Œæ­£å¦‚å¤§äººä¹‹é£å§¿ï¼Œç£Šè½å¦è¡ã€‚',
        'ç‘œï¼šè¿™é›¾æ­£å¥½ï¼Œå¯ä»¥è—ä½æˆ‘ï¼Œè®©æ‚¨æ‰¾ä¸åˆ°æˆ‘ï¼Œåªèƒ½ä¸ºæˆ‘ç€æ€¥ã€‚',
        'ç‘¾ï¼šçœ‹è§æ­¤ç”»ï¼Œæ€€ç‘¾ä¾¿æƒ³ä¸ºå¤§äººæŠšç´ä¸€æ›²ï¼Œä»¥åŠ©é›…å…´ã€‚',
        'ç‘œï¼šå…„é•¿çš„ç´å£°å››å¹³å…«ç¨³ï¼Œæˆ‘çš„ç´å£°ï¼Œåªæƒ³ä¹±äº†æ‚¨çš„å¿ƒã€‚',
        'ç‘¾ï¼šä¸çŸ¥å¤§äººæ˜¯å¦ä¹Ÿå–œçˆ±å…°èŠ±ï¼Ÿå…¶å“æ€§é«˜æ´ï¼Œæ­£å¦‚æ‚¨ä¸€èˆ¬ã€‚',
        'ç‘œï¼šæ¯”èµ·å…°èŠ±ï¼Œæˆ‘æ›´æ„¿åšç¼ ç»•æ‚¨çš„è—¤ï¼Œè‡³æ­»æ–¹ä¼‘ã€‚',
        'ç‘¾ï¼šæˆ‘ä¼šå°†æ­¤ç”»çš„ç²¾å¦™ä¹‹å¤„è¯´ä¸å¼Ÿå¼Ÿå¬ï¼Œè®©ä»–ä¹Ÿå­¦ä¹ ä¸€ç•ªã€‚',
        'ç‘œï¼šå…„é•¿æ€»æƒ³æ•™æˆ‘ï¼Œä»–æ€ä¹ˆä¸æ˜ç™½ï¼Œæˆ‘å”¯ä¸€æƒ³å­¦çš„ï¼Œæ˜¯å¦‚ä½•å¾—åˆ°æ‚¨çš„å¿ƒã€‚',
        'ç‘¾ï¼šå±±æ°´æœ‰ç›¸é€¢ï¼Œæ€€ç‘¾äº¦ç›¼èƒ½å¸¸ä¼´å¤§äººå·¦å³ï¼Œè†å¬æ•™è¯²ã€‚',
        'ç‘œï¼šæˆ‘ä¸ä¿¡ç›¸é€¢ï¼Œæˆ‘åªæ±‚ï¼Œèƒ½å°†æ‚¨ç‰¢ç‰¢æŠ“åœ¨æ‰‹ä¸­ã€‚',
        'ç‘¾ï¼šè¿™ç”»å·è™½ç¾ï¼Œå´ä¸åŠå¤§äººä¸‡ä¸€ã€‚',
        'ç‘œï¼šæ‚¨æ‰æ˜¯è¿™ä¸–é—´ï¼Œå”¯ä¸€çš„ç»è‰²ã€‚',
        'ç‘¾ï¼šè¯·æ•æ€€ç‘¾æ„šé’ï¼Œæœªèƒ½å®Œå…¨é¢†ä¼šç”»ä¸­æ·±æ„ï¼Œè¿˜æœ›å¤§äººä¸åèµæ•™ã€‚',
        'ç‘œï¼šæ­¤ç”»çš„æ·±æ„ï¼Œä¾¿æ˜¯â€˜ç­‰å¾…â€™ã€‚å¤§äººï¼Œæ‚¨è®©æˆ‘ç­‰äº†å¤ªä¹…ã€‚',
        'ç‘¾ï¼šå¤§äººåºœä¸Šçš„èŒ¶æ€»æ˜¯æå¥½çš„ï¼Œé…ä¸Šæ­¤ç”»ï¼Œç›¸å¾—ç›Šå½°ã€‚',
        'ç‘œï¼šèŒ¶æœ‰ä»€ä¹ˆå¥½å–çš„ï¼Œæ‚¨å°å°æˆ‘çš„çœ¼æ³ªï¼Œå’¸çš„ï¼Œä½†æ»šçƒ«ã€‚',
        'ç‘¾ï¼šè‹¥æ‚¨ä¸å«Œå¼ƒï¼Œæ€€ç‘¾æ„¿ä¸ºæ‚¨ç ”å¢¨ï¼Œæ‚¨äº²è‡ªä½œä¸€å¹…å¦‚ä½•ï¼Ÿ',
        'ç‘œï¼šä¸å¿…åŠ³çƒ¦å¤§äººåŠ¨ç¬”ï¼Œæ‚¨åªè¦èººç€ï¼Œè®©æˆ‘æ¥å°†æ‚¨ç”»ä¸‹ï¼Œè—èµ·æ¥ï¼Œåªç»™æˆ‘ä¸€ä¸ªäººçœ‹ã€‚',
      ];

      const SENDER_AVATARS = {
        é¡¾æ€€ç‘œ: 'https://files.catbox.moe/kq4ft9.jpg',
        é¡¾æ€€ç‘¾: 'https://files.catbox.moe/f18jm2.jpg',
        æ¡ç‘¾æ€€ç‘œ: 'https://files.catbox.moe/aeea20.jpg',
      };

      //
      const CURRENT_USER_ID = '{{user}}';

      // éªŒè¯AIå›å¤æ˜¯å¦åŒ…å«æ­£ç¡®çš„æ ‡ç­¾æ ¼å¼
      function validateAIReplyTags(aiReplyText, currentContact) {
        const isGroupChat = currentContact.id.startsWith('group_');
        const currentContactName = currentContact.name;

        if (isGroupChat) {
          // æ£€æŸ¥æ˜¯å¦åŒ…å«æ­£ç¡®çš„ç¾¤èŠæ ‡ç­¾
          const groupTagPattern = new RegExp(`\\[å¤šäººå°ç¬º:${currentContactName}\\]`, 'i');
          const hasGroupTag = groupTagPattern.test(aiReplyText);

          // æ£€æŸ¥æ˜¯å¦é”™è¯¯åŒ…å«äº†ç§èŠæ ‡ç­¾
          const privateTagPattern = new RegExp(
            `\\[(?:{{user}}|ä½ |user)å’Œ.+?çš„ç§å¯†å°ç¬º\\]|\\[.+?å’Œ(?:{{user}}|ä½ |user)çš„ç§å¯†å°ç¬º\\]`,
            'i',
          );
          const hasPrivateTag = privateTagPattern.test(aiReplyText);

          return { hasCorrectTag: hasGroupTag, hasWrongTag: hasPrivateTag };
        } else {
          // æ£€æŸ¥æ˜¯å¦åŒ…å«æ­£ç¡®çš„ç§èŠæ ‡ç­¾
          const privateTagPattern = new RegExp(
            `\\[(?:(?:{{user}}|ä½ |user)å’Œ${currentContactName}|${currentContactName}å’Œ(?:{{user}}|ä½ |user))çš„ç§å¯†å°ç¬º\\]`,
            'i',
          );
          const hasPrivateTag = privateTagPattern.test(aiReplyText);

          // æ£€æŸ¥æ˜¯å¦é”™è¯¯åŒ…å«äº†ç¾¤èŠæ ‡ç­¾
          const groupTagPattern = new RegExp(`\\[å¤šäººå°ç¬º:.+?\\]`, 'i');
          const hasGroupTag = groupTagPattern.test(aiReplyText);

          return { hasCorrectTag: hasPrivateTag, hasWrongTag: hasGroupTag };
        }
      }

      function applyTheme(theme) {
        const root = document.documentElement;
        for (const [key, value] of Object.entries(theme.colors)) {
          root.style.setProperty(key, value);
        }
        document.body.style.background = theme.backgrounds.body;
        document.getElementById('contactsPage').style.backgroundImage = theme.backgrounds.contacts;
        document.getElementById('messageContainer').style.backgroundImage = theme.backgrounds.messages;
      }

      function parseDataSource(forceReset = false) {
        if (forceReset) {
          tempMessages = {};
        }
        const dataContainer = document.getElementById('data-source');
        if (!dataContainer) {
          return [];
        }

        let rawText = (dataContainer.textContent || dataContainer.innerText)
          .replace(/<é±¼é›å°ç¬º>/g, 'é±¼é›å°ç¬º_START')
          .replace(/<\/é±¼é›å°ç¬º>/g, 'é±¼é›å°ç¬º_END');

        // å¦‚æœæ•°æ®æºä¸ºç©ºæˆ–åªæœ‰æ ‡ç­¾ï¼Œè¿”å›ç©ºæ•°ç»„
        if (!rawText || rawText.trim() === 'é±¼é›å°ç¬º_START' || rawText.trim() === '') {
          return [];
        }

        // æ”¹è¿›çš„åˆ†å‰²é€»è¾‘ï¼Œæ›´ç²¾ç¡®åœ°è¯†åˆ«æ ‡ç­¾
        const sections = rawText
          .split(/(?=\[(?:{{user}}|ä½ |user)å’Œ.+?çš„ç§å¯†å°ç¬º\]|\[.+?å’Œ(?:{{user}}|ä½ |user)çš„ç§å¯†å°ç¬º\]|\[å¤šäººå°ç¬º:.+?\])/)
          .filter(s => s.trim() !== '' && s.trim() !== 'é±¼é›å°ç¬º_START');

        const contacts = [];

        for (const section of sections) {
          // æ›´ç²¾ç¡®çš„ç§å¯†å°ç¬ºåŒ¹é…
          const privateMatch = section.match(
            /\[(?:(?:{{user}}|ä½ |user)å’Œ(.+?)|(.+?)å’Œ(?:{{user}}|ä½ |user))çš„ç§å¯†å°ç¬º\]([\s\S]*)/,
          );

          // æ›´ç²¾ç¡®çš„å¤šäººå°ç¬ºåŒ¹é…
          const groupMatch = section.match(/\[å¤šäººå°ç¬º:([\s\S]+?)\]\s*([\s\S]*)/);

          const messageRegex = /\[([^\|]+)\|([^\|]+)\|([^\]]+)\]/g;
          let msgMatch;

          if (privateMatch) {
            const partnerName = (privateMatch[1] || privateMatch[2]).trim();
            const messagesContent = privateMatch[3];
            const messages = [];

            while ((msgMatch = messageRegex.exec(messagesContent)) !== null) {
              let senderName = msgMatch[1].replace(/å°ç¬º|æœ€åä¸€æ¡/g, '').trim();

              if (senderName === 'ä½ ' || senderName === 'user') {
                senderName = CURRENT_USER_ID;
              }
              messages.push({ sender: senderName, text: msgMatch[2], time: msgMatch[3] });
            }

            contacts.push({
              id: partnerName,
              name: partnerName,
              avatarUrl: SENDER_AVATARS[partnerName] || '',
              lastMessage: messages.length > 0 ? messages[messages.length - 1] : { text: '', time: '' },
              messages: messages,
              chatType: 'private', // æ·»åŠ èŠå¤©ç±»å‹æ ‡è¯†
            });
          } else if (groupMatch) {
            const groupName = groupMatch[1].trim();
            const messagesContent = groupMatch[2];
            const messages = [];
            const members = new Set();

            while ((msgMatch = messageRegex.exec(messagesContent)) !== null) {
              let senderName = msgMatch[1].replace(/å°ç¬º|æœ€åä¸€æ¡/g, '').trim();
              if (senderName === 'ä½ ' || senderName === 'user') {
                senderName = CURRENT_USER_ID;
              }
              if (senderName !== CURRENT_USER_ID) {
                members.add(senderName);
              }
              messages.push({ sender: senderName, text: msgMatch[2], time: msgMatch[3] });
            }

            contacts.push({
              id: `group_${groupName}`,
              name: groupName,
              avatarUrl: SENDER_AVATARS[groupName] || '',
              lastMessage: messages.length > 0 ? messages[messages.length - 1] : { text: '', time: '' },
              messages: messages,
              members: Array.from(members),
              chatType: 'group', // æ·»åŠ èŠå¤©ç±»å‹æ ‡è¯†
            });
          }
        }
        return contacts;
      }

      function initContacts() {
        const contactList = document.getElementById('contactList');
        if (!contactList) return;
        contactList.innerHTML = '';

        contactsData.forEach(contact => {
          const lastStoredMessage = previousMessages[contact.id];
          const currentLastMessage = contact.lastMessage;
          // åˆ¤æ–­æ–°æ¶ˆæ¯æ—¶ï¼Œç»Ÿä¸€ä½¿ç”¨ CURRENT_USER_ID
          contact.isNew =
            currentLastMessage.text &&
            currentLastMessage.sender !== CURRENT_USER_ID &&
            (!lastStoredMessage || JSON.stringify(lastStoredMessage) !== JSON.stringify(currentLastMessage));
        });

        contactsData.forEach(contact => {
          const li = document.createElement('li');
          li.className = 'contact-item';
          if (contact.isNew) {
            li.classList.add('new');
          }

          let messagePreview = contact.lastMessage.text || '';
          if (messagePreview.length > 8) {
            messagePreview = messagePreview.substring(0, 8) + 'â€¦';
          }

          li.innerHTML = `
                    <div class="avatar-wrapper">
                        <img class="avatar" src="${contact.avatarUrl}" alt="${contact.name}">
                    </div>
                    <div class="contact-info">
                        <div class="contact-name-wrapper">
                            <div class="contact-name">${contact.name}</div>
                            <div class="new-badge">æ–°</div>
                        </div>
                        <div class="last-message">${messagePreview}</div>
                    </div>
                `;
          li.addEventListener('click', () => {
            openChat(contact);
            if (contact.isNew) {
              li.classList.remove('new');
              previousMessages[contact.id] = contact.lastMessage;
              localStorage.setItem('previousMessages', JSON.stringify(previousMessages));
            }
          });
          contactList.appendChild(li);
        });
      }

      function openChat(contact) {
        currentContact = contact;
        const chatTitle = document.getElementById('chatTitle');
        const messageList = document.getElementById('messageList');
        const chatPage = document.getElementById('chatPage');
        const messageInput = document.getElementById('messageInput');

        if (!chatTitle || !messageList || !chatPage) return;

        chatTitle.innerHTML = `
                <img class="chat-avatar" src="${contact.avatarUrl}" alt="${contact.name}">
                <span>${contact.name}</span>
            `;
        messageList.innerHTML = '';
        contact.messages.forEach(message => {
          addMessageToChat(message.text, message.sender === CURRENT_USER_ID, message.time, message.sender);
        });

        if (tempMessages[contact.id]) {
          tempMessages[contact.id].forEach(message => {
            addMessageToChat(message.text, message.sender === CURRENT_USER_ID, message.time, message.sender);
          });
        }
        if (messageInput) {
          messageInput.value = '';
        }

        chatPage.classList.add('active');
      }

      function addMessageToChat(text, isSender, time, senderId = '') {
        const messageList = document.getElementById('messageList');
        if (!messageList) return;

        const li = document.createElement('li');
        li.className = `message-item ${isSender ? 'sender' : 'receiver'}`;

        // ä¸ºæ¶ˆæ¯æ·»åŠ å”¯ä¸€ID
        const messageId = `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        li.setAttribute('data-message-id', messageId);
        li.setAttribute('data-sender', senderId || (isSender ? CURRENT_USER_ID : ''));
        li.setAttribute('data-text', text);
        li.setAttribute('data-time', time);

        let badgeHTML = '';
        if (currentContact && currentContact.id.startsWith('group_') && !isSender) {
          if (senderId === 'é¡¾æ€€ç‘¾') {
            badgeHTML = '<div class="sender-badge jin">ç‘¾</div>';
          } else if (senderId === 'é¡¾æ€€ç‘œ') {
            badgeHTML = '<div class="sender-badge yu">ç‘œ</div>';
          }
        }

        li.innerHTML = `
                ${badgeHTML}
                <div class="message-content-wrapper">
                    <div class="message-content">${text}</div>
                    <div class="message-time">${time}</div>
                </div>
            `;

        // æ·»åŠ é•¿æŒ‰åˆ é™¤åŠŸèƒ½
        addLongPressDeleteHandler(li);

        messageList.appendChild(li);
        const messageContainer = document.getElementById('messageContainer');
        if (messageContainer) messageContainer.scrollTop = messageContainer.scrollHeight;
      }

      function getCurrentTime() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        return `${hours}:${minutes}`;
      }

      // æ·»åŠ é•¿æŒ‰åˆ é™¤åŠŸèƒ½
      function addLongPressDeleteHandler(messageElement) {
        let longPressTimer = null;

        const startLongPress = e => {
          e.preventDefault();

          longPressTimer = setTimeout(() => {
            // æ·»åŠ éœ‡åŠ¨åé¦ˆï¼ˆå¦‚æœè®¾å¤‡æ”¯æŒï¼‰
            if (navigator.vibrate) {
              navigator.vibrate(50);
            }

            // ç›´æ¥æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
            showDeleteConfirmDialog(messageElement);
          }, 500); // 500msé•¿æŒ‰è§¦å‘
        };

        const cancelLongPress = () => {
          if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
          }
        };

        // é¼ æ ‡äº‹ä»¶
        messageElement.addEventListener('mousedown', startLongPress);
        messageElement.addEventListener('mouseup', cancelLongPress);
        messageElement.addEventListener('mouseleave', cancelLongPress);

        // è§¦æ‘¸äº‹ä»¶
        messageElement.addEventListener('touchstart', startLongPress, { passive: false });
        messageElement.addEventListener('touchend', cancelLongPress);
        messageElement.addEventListener('touchcancel', cancelLongPress);
        messageElement.addEventListener('touchmove', cancelLongPress);
      }

      // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
      function showDeleteConfirmDialog(messageElement) {
        const overlay = document.getElementById('deleteConfirmOverlay');
        const messageText = messageElement.getAttribute('data-text');
        const sender = messageElement.getAttribute('data-sender');
        const messageContent = document.getElementById('deleteConfirmMessage');

        // è®¾ç½®ç¡®è®¤æ¶ˆæ¯å†…å®¹
        let senderName = '';
        if (sender === CURRENT_USER_ID) {
          senderName = 'æ‚¨';
        } else if (sender === 'é¡¾æ€€ç‘¾') {
          senderName = 'æ€€ç‘¾';
        } else if (sender === 'é¡¾æ€€ç‘œ') {
          senderName = 'æ€€ç‘œ';
        } else {
          senderName = sender;
        }

        const truncatedText = messageText.length > 20 ? messageText.substring(0, 20) + '...' : messageText;
        messageContent.textContent = `ç¡®å®šè¦åˆ é™¤${senderName}çš„è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ\n"${truncatedText}"`;

        // æ˜¾ç¤ºå¯¹è¯æ¡†
        overlay.classList.add('show');

        // ç»‘å®šæŒ‰é’®äº‹ä»¶
        const confirmBtn = document.getElementById('deleteConfirmBtn');
        const cancelBtn = document.getElementById('deleteCancelBtn');

        const handleConfirm = () => {
          hideDeleteConfirmDialog();
          deleteMessage(messageElement);
          confirmBtn.removeEventListener('click', handleConfirm);
          cancelBtn.removeEventListener('click', handleCancel);
          overlay.removeEventListener('click', handleOverlayClick);
        };

        const handleCancel = () => {
          hideDeleteConfirmDialog();
          confirmBtn.removeEventListener('click', handleConfirm);
          cancelBtn.removeEventListener('click', handleCancel);
          overlay.removeEventListener('click', handleOverlayClick);
        };

        const handleOverlayClick = e => {
          if (e.target === overlay) {
            handleCancel();
          }
        };

        confirmBtn.addEventListener('click', handleConfirm);
        cancelBtn.addEventListener('click', handleCancel);
        overlay.addEventListener('click', handleOverlayClick);

        // ESCé”®å–æ¶ˆ
        const handleEscKey = e => {
          if (e.key === 'Escape') {
            handleCancel();
            document.removeEventListener('keydown', handleEscKey);
          }
        };
        document.addEventListener('keydown', handleEscKey);
      }

      // éšè—åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
      function hideDeleteConfirmDialog() {
        const overlay = document.getElementById('deleteConfirmOverlay');
        overlay.classList.remove('show');
      }

      // åˆ é™¤æ¶ˆæ¯å‡½æ•°
      async function deleteMessage(messageElement) {
        if (!currentContact || !messageElement) return;

        const messageId = messageElement.getAttribute('data-message-id');
        const sender = messageElement.getAttribute('data-sender');
        const text = messageElement.getAttribute('data-text');
        const time = messageElement.getAttribute('data-time');

        // æ·»åŠ åˆ é™¤åŠ¨ç”»
        messageElement.style.transition = 'all 0.3s ease';
        messageElement.style.transform = 'translateX(-100%)';
        messageElement.style.opacity = '0';

        setTimeout(() => {
          // ä»DOMä¸­ç§»é™¤æ¶ˆæ¯
          messageElement.remove();
        }, 300);

        // ä»ä¸´æ—¶æ¶ˆæ¯å­˜å‚¨ä¸­åˆ é™¤
        if (tempMessages[currentContact.id]) {
          tempMessages[currentContact.id] = tempMessages[currentContact.id].filter(
            msg => !(msg.sender === sender && msg.text === text && msg.time === time),
          );
        }

        // ä»åŸå§‹æ•°æ®æºä¸­åˆ é™¤æ¶ˆæ¯
        try {
          await removeMessageFromDataSource(currentContact, sender, text, time);
        } catch (error) {
          // é™é»˜å¤„ç†é”™è¯¯
        }
      }

      // ä»æ•°æ®æºä¸­åˆ é™¤æ¶ˆæ¯
      async function removeMessageFromDataSource(contact, sender, text, time) {
        const dataSource = document.getElementById('data-source');
        if (!dataSource) return;

        const currentContent = dataSource.textContent;
        const yujianMatch = currentContent.match(/<é±¼é›å°ç¬º>([\s\S]*?)<\/é±¼é›å°ç¬º>/);
        let yujianContent = yujianMatch ? yujianMatch[1] : currentContent;

        // æ„å»ºè¦åˆ é™¤çš„æ¶ˆæ¯æ ¼å¼
        const senderName = sender === CURRENT_USER_ID ? '{{user}}' : sender;
        const messageToDelete = `[${senderName}|${text}|${time}]`;

        // ä»å†…å®¹ä¸­åˆ é™¤è¯¥æ¶ˆæ¯
        const lines = yujianContent.split('\n');
        const filteredLines = lines.filter(line => line.trim() !== messageToDelete);
        const newYujianContent = filteredLines.join('\n');

        const updatedText = `<é±¼é›å°ç¬º>\n${newYujianContent.trim()}\n</é±¼é›å°ç¬º>`;

        // æ›´æ–°æ•°æ®æº
        dataSource.textContent = updatedText;

        // ä½¿ç”¨SillyTavernçš„æ–¹å¼ä¿å­˜æ›´æ–°
        if (typeof setChatMessages === 'function') {
          const currentId = typeof getCurrentMessageId === 'function' ? getCurrentMessageId() : 0;
          await setChatMessages([{ message_id: currentId, message: updatedText }], { refresh: 'none' });
        }
      }

      // è¿‡æ»¤AIå›å¤ï¼Œåªæå–ç¬¦åˆæ ¼å¼çš„å°ç¬ºå†…å®¹
      function filterAIReply(aiReplyText, currentContact) {
        const filteredMessages = [];
        const isGroupChat = currentContact.id.startsWith('group_');
        const currentContactName = currentContact.name;

        // é¦–å…ˆæŒ‰èŠå¤©æ ‡ç­¾åˆ†å‰²AIå›å¤ï¼Œåªå¤„ç†å½“å‰èŠå¤©çš„éƒ¨åˆ†
        const currentChatContent = extractCurrentChatContent(aiReplyText, currentContact);

        if (!currentChatContent) {
          // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å½“å‰èŠå¤©çš„å†…å®¹ï¼Œè¿”å›ç©ºæ•°ç»„
          return filteredMessages;
        }

        // åŒ¹é…å°ç¬ºæ ¼å¼ï¼š[å‘é€è€…|å†…å®¹|æ—¶é—´] - æ”¹è¿›ç‰ˆï¼Œæ”¯æŒçœç•¥å·ç­‰ç‰¹æ®Šå­—ç¬¦
        const messageRegex = /\[([^|\]]+)\|([^|\]]*?)\|([^|\]]+)\]/g;
        let match;

        while ((match = messageRegex.exec(currentChatContent)) !== null) {
          let senderName = match[1].trim();
          const messageContent = match[2].trim();
          const messageTime = match[3].trim();

          // éªŒè¯å†…å®¹ä¸ä¸ºç©ºï¼ˆåŒ…æ‹¬åªæœ‰çœç•¥å·çš„æƒ…å†µï¼‰
          if (!messageContent || messageContent === '') {
            continue;
          }

          // å¤„ç†å‘é€è€…åç§° - ç»Ÿä¸€è¯†åˆ«ç”¨æˆ·èº«ä»½
          if (
            senderName === 'ä½ ' ||
            senderName === 'user' ||
            senderName === '{{user}}' ||
            senderName === CURRENT_USER_ID
          ) {
            // è¿™æ˜¯ç”¨æˆ·çš„æ¶ˆæ¯ï¼Œè·³è¿‡ä¸å¤„ç†ï¼ˆå› ä¸ºç”¨æˆ·æ¶ˆæ¯å·²ç»åœ¨å‘é€æ—¶æ·»åŠ äº†ï¼‰
            continue;
          }

          // åªå¤„ç†AIè§’è‰²çš„å›å¤æ¶ˆæ¯
          if (messageContent) {
            // åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦å±äºå½“å‰èŠå¤© - æ›´ä¸¥æ ¼çš„éªŒè¯
            let shouldInclude = false;

            if (isGroupChat) {
              // å¤šäººç¾¤èŠï¼šä¸¥æ ¼æ£€æŸ¥å‘é€è€…æ˜¯å¦æ˜¯å½“å‰ç¾¤çš„æˆå‘˜
              if (currentContact.members && currentContact.members.includes(senderName)) {
                shouldInclude = true;
              }
              // ç‰¹æ®Šæƒ…å†µï¼šå¦‚æœæ˜¯"æ¡ç‘¾æ€€ç‘œ"ç¾¤èŠï¼Œåªå…è®¸é¡¾æ€€ç‘¾å’Œé¡¾æ€€ç‘œå‘è¨€
              else if (currentContactName === 'æ¡ç‘¾æ€€ç‘œ' && (senderName === 'é¡¾æ€€ç‘¾' || senderName === 'é¡¾æ€€ç‘œ')) {
                shouldInclude = true;
              }
            } else {
              // ä¸ªäººç§èŠï¼šä¸¥æ ¼åªæ˜¾ç¤ºå½“å‰è”ç³»äººçš„æ¶ˆæ¯
              if (senderName === currentContactName) {
                shouldInclude = true;
              }
            }

            if (shouldInclude) {
              filteredMessages.push({
                sender: senderName,
                text: messageContent,
                time: messageTime,
              });
            }
          }
        }

        return filteredMessages;
      }

      // æå–å½“å‰èŠå¤©çš„å†…å®¹éƒ¨åˆ†
      function extractCurrentChatContent(aiReplyText, currentContact) {
        const isGroupChat = currentContact.id.startsWith('group_');
        const currentContactName = currentContact.name;

        let targetTag;
        if (isGroupChat) {
          targetTag = `[å¤šäººå°ç¬º:${currentContactName}]`;
        } else {
          // ç§èŠå¯èƒ½æœ‰ä¸¤ç§æ ¼å¼
          targetTag = `[{{user}}å’Œ${currentContactName}çš„ç§å¯†å°ç¬º]`;
          const alternativeTag = `[${currentContactName}å’Œ{{user}}çš„ç§å¯†å°ç¬º]`;

          // æ£€æŸ¥å“ªç§æ ¼å¼å­˜åœ¨
          if (aiReplyText.includes(alternativeTag)) {
            targetTag = alternativeTag;
          }
        }

        // æŸ¥æ‰¾ç›®æ ‡æ ‡ç­¾çš„ä½ç½®
        const tagIndex = aiReplyText.indexOf(targetTag);
        if (tagIndex === -1) {
          // æ²¡æœ‰æ‰¾åˆ°å½“å‰èŠå¤©çš„æ ‡ç­¾ï¼Œè¿”å›null
          return null;
        }

        // ä»æ ‡ç­¾å¼€å§‹æå–å†…å®¹
        const contentStart = tagIndex + targetTag.length;
        let contentEnd = aiReplyText.length;

        // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªèŠå¤©æ ‡ç­¾çš„ä½ç½®ï¼Œä½œä¸ºå½“å‰èŠå¤©å†…å®¹çš„ç»“æŸä½ç½®
        const nextTagPatterns = [
          /\[(?:{{user}}|ä½ |user)å’Œ.+?çš„ç§å¯†å°ç¬º\]/g,
          /\[.+?å’Œ(?:{{user}}|ä½ |user)çš„ç§å¯†å°ç¬º\]/g,
          /\[å¤šäººå°ç¬º:.+?\]/g,
        ];

        for (const pattern of nextTagPatterns) {
          pattern.lastIndex = contentStart; // ä»å½“å‰æ ‡ç­¾åå¼€å§‹æœç´¢
          const nextMatch = pattern.exec(aiReplyText);
          if (nextMatch && nextMatch.index < contentEnd) {
            contentEnd = nextMatch.index;
          }
        }

        return aiReplyText.substring(contentStart, contentEnd).trim();
      }

      // å¤„ç†AIå›å¤ä¸­çš„æ‰€æœ‰èŠå¤©å†…å®¹
      function processAllChatsInAIReply(aiReplyText) {
        const allChatMessages = {};

        // è¯†åˆ«æ‰€æœ‰èŠå¤©æ ‡ç­¾
        const chatTagPatterns = [
          /\[(?:{{user}}|ä½ |user)å’Œ(.+?)çš„ç§å¯†å°ç¬º\]/g,
          /\[(.+?)å’Œ(?:{{user}}|ä½ |user)çš„ç§å¯†å°ç¬º\]/g,
          /\[å¤šäººå°ç¬º:(.+?)\]/g,
        ];

        const foundChats = [];

        // æŸ¥æ‰¾æ‰€æœ‰èŠå¤©æ ‡ç­¾
        chatTagPatterns.forEach((pattern, patternIndex) => {
          let match;
          pattern.lastIndex = 0; // é‡ç½®æ­£åˆ™è¡¨è¾¾å¼
          while ((match = pattern.exec(aiReplyText)) !== null) {
            const chatName = match[1].trim();
            const isGroupChat = patternIndex === 2; // ç¬¬ä¸‰ä¸ªæ¨¡å¼æ˜¯ç¾¤èŠ
            const tagStart = match.index;
            const fullTag = match[0];

            foundChats.push({
              name: chatName,
              isGroup: isGroupChat,
              tagStart: tagStart,
              fullTag: fullTag,
              id: isGroupChat ? `group_${chatName}` : chatName,
            });
          }
        });

        // æŒ‰æ ‡ç­¾ä½ç½®æ’åº
        foundChats.sort((a, b) => a.tagStart - b.tagStart);

        // æå–æ¯ä¸ªèŠå¤©çš„å†…å®¹
        foundChats.forEach((chat, index) => {
          const contentStart = chat.tagStart + chat.fullTag.length;
          let contentEnd = aiReplyText.length;

          // æ‰¾åˆ°ä¸‹ä¸€ä¸ªèŠå¤©æ ‡ç­¾çš„ä½ç½®
          if (index + 1 < foundChats.length) {
            contentEnd = foundChats[index + 1].tagStart;
          }

          const chatContent = aiReplyText.substring(contentStart, contentEnd).trim();

          if (chatContent) {
            // è§£æè¿™ä¸ªèŠå¤©çš„æ¶ˆæ¯
            const messages = parseMessagesFromContent(chatContent, chat);
            if (messages.length > 0) {
              allChatMessages[chat.id] = {
                chatInfo: chat,
                messages: messages,
              };
            }
          }
        });

        return allChatMessages;
      }

      // ä»èŠå¤©å†…å®¹ä¸­è§£ææ¶ˆæ¯
      function parseMessagesFromContent(content, chatInfo) {
        const messages = [];
        const messageRegex = /\[([^|\]]+)\|([^|\]]*?)\|([^|\]]+)\]/g;
        let match;

        while ((match = messageRegex.exec(content)) !== null) {
          let senderName = match[1].trim();
          const messageContent = match[2].trim();
          const messageTime = match[3].trim();

          // éªŒè¯å†…å®¹ä¸ä¸ºç©º
          if (!messageContent || messageContent === '') {
            continue;
          }

          // å¤„ç†å‘é€è€…åç§°
          if (
            senderName === 'ä½ ' ||
            senderName === 'user' ||
            senderName === '{{user}}' ||
            senderName === CURRENT_USER_ID
          ) {
            // è·³è¿‡ç”¨æˆ·æ¶ˆæ¯ï¼ˆç”¨æˆ·æ¶ˆæ¯å·²ç»åœ¨å‘é€æ—¶æ·»åŠ äº†ï¼‰
            continue;
          }

          // éªŒè¯å‘é€è€…æ˜¯å¦å±äºå½“å‰èŠå¤©
          let isValidSender = false;

          if (chatInfo.isGroup) {
            // ç¾¤èŠï¼šæ£€æŸ¥å‘é€è€…æ˜¯å¦æ˜¯ç¾¤æˆå‘˜
            const contact = contactsData.find(c => c.id === chatInfo.id);
            if (contact && contact.members && contact.members.includes(senderName)) {
              isValidSender = true;
            }
            // ç‰¹æ®Šæƒ…å†µï¼šæ¡ç‘¾æ€€ç‘œç¾¤èŠ
            else if (chatInfo.name === 'æ¡ç‘¾æ€€ç‘œ' && (senderName === 'é¡¾æ€€ç‘¾' || senderName === 'é¡¾æ€€ç‘œ')) {
              isValidSender = true;
            }
          } else {
            // ç§èŠï¼šæ£€æŸ¥å‘é€è€…æ˜¯å¦æ˜¯å½“å‰è”ç³»äºº
            if (senderName === chatInfo.name) {
              isValidSender = true;
            }
          }

          if (isValidSender) {
            messages.push({
              sender: senderName,
              text: messageContent,
              time: messageTime,
            });
          }
        }

        return messages;
      }

      // æ‰¾åˆ°èŠå¤©ä¸­æ’å…¥æ–°æ¶ˆæ¯çš„æ­£ç¡®ä½ç½®ï¼ˆåœ¨æœ€åä¸€æ¡æ¶ˆæ¯åé¢ï¼‰
      function findInsertPositionForChat(content, chatTag, chatTagIndex) {
        // ä»èŠå¤©æ ‡ç­¾å¼€å§‹æœç´¢
        const searchStart = chatTagIndex + chatTag.length;

        // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªèŠå¤©æ ‡ç­¾çš„ä½ç½®ï¼Œä½œä¸ºå½“å‰èŠå¤©çš„ç»“æŸä½ç½®
        const nextChatTagPatterns = [
          /\[(?:{{user}}|ä½ |user)å’Œ.+?çš„ç§å¯†å°ç¬º\]/g,
          /\[.+?å’Œ(?:{{user}}|ä½ |user)çš„ç§å¯†å°ç¬º\]/g,
          /\[å¤šäººå°ç¬º:.+?\]/g,
        ];

        let chatEndPosition = content.length;

        for (const pattern of nextChatTagPatterns) {
          pattern.lastIndex = searchStart;
          const nextMatch = pattern.exec(content);
          if (nextMatch && nextMatch.index < chatEndPosition) {
            chatEndPosition = nextMatch.index;
          }
        }

        // åœ¨å½“å‰èŠå¤©èŒƒå›´å†…æŸ¥æ‰¾æœ€åä¸€æ¡æ¶ˆæ¯
        const chatContent = content.substring(searchStart, chatEndPosition);
        const messagePattern = /\[[^\|\]]+\|[^\|\]]*\|[^\]]+\]/g;
        let lastMessageEnd = searchStart;
        let match;

        while ((match = messagePattern.exec(chatContent)) !== null) {
          lastMessageEnd = searchStart + match.index + match[0].length;
        }

        // æ‰¾åˆ°æœ€åä¸€æ¡æ¶ˆæ¯åçš„æ¢è¡Œä½ç½®
        let insertPosition = lastMessageEnd;
        while (
          insertPosition < chatEndPosition &&
          (content[insertPosition] === '\n' || content[insertPosition] === '\r')
        ) {
          insertPosition++;
        }

        return insertPosition;
      }

      // æ‰¾åˆ°èŠå¤©çš„ç»“æŸä½ç½®
      function findChatEndPosition(content, chatTagIndex) {
        const searchStart = chatTagIndex;

        // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªèŠå¤©æ ‡ç­¾çš„ä½ç½®
        const nextChatTagPatterns = [
          /\[(?:{{user}}|ä½ |user)å’Œ.+?çš„ç§å¯†å°ç¬º\]/g,
          /\[.+?å’Œ(?:{{user}}|ä½ |user)çš„ç§å¯†å°ç¬º\]/g,
          /\[å¤šäººå°ç¬º:.+?\]/g,
        ];

        let chatEndPosition = content.length;

        for (const pattern of nextChatTagPatterns) {
          pattern.lastIndex = searchStart + 1;
          const nextMatch = pattern.exec(content);
          if (nextMatch && nextMatch.index < chatEndPosition) {
            chatEndPosition = nextMatch.index;
          }
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰</é±¼é›å°ç¬º>æ ‡ç­¾
        const endTagIndex = content.indexOf('</é±¼é›å°ç¬º>', searchStart);
        if (endTagIndex !== -1 && endTagIndex < chatEndPosition) {
          chatEndPosition = endTagIndex;
        }

        return chatEndPosition;
      }

      // ä¿å­˜æ‰€æœ‰èŠå¤©çš„æ¶ˆæ¯åˆ°æ•°æ®æº - åªæ·»åŠ æ–°æ¶ˆæ¯ï¼Œä¸é‡å¤æ—§å†…å®¹
      async function saveAllChatsToDataSource(allChatMessages) {
        const dataSource = document.getElementById('data-source');
        if (!dataSource) return;

        // è·å–å½“å‰æ•°æ®æºå†…å®¹
        let currentContent = dataSource.textContent;

        // ä¸ºæ¯ä¸ªèŠå¤©æ·»åŠ æ–°æ¶ˆæ¯
        for (const [chatId, chatData] of Object.entries(allChatMessages)) {
          const { chatInfo, messages } = chatData;

          // æ„å»ºèŠå¤©æ ‡ç­¾
          let chatTag;
          if (chatInfo.isGroup) {
            chatTag = `[å¤šäººå°ç¬º:${chatInfo.name}]`;
          } else {
            chatTag = `[{{user}}å’Œ${chatInfo.name}çš„ç§å¯†å°ç¬º]`;
          }

          // åªæ·»åŠ æ–°æ¶ˆæ¯ï¼Œä¸é‡å¤ç°æœ‰æ¶ˆæ¯
          for (const msg of messages) {
            const messageString = `[${msg.sender}|${msg.text}|${msg.time}]`;

            // æ£€æŸ¥è¿™æ¡æ¶ˆæ¯æ˜¯å¦å·²ç»å­˜åœ¨äºæ•´ä¸ªæ•°æ®æºä¸­
            if (currentContent.includes(messageString)) {
              continue; // è·³è¿‡å·²å­˜åœ¨çš„æ¶ˆæ¯
            }

            // æŸ¥æ‰¾èŠå¤©æ ‡ç­¾ä½ç½®
            const tagIndex = currentContent.indexOf(chatTag);

            if (tagIndex !== -1) {
              // æ‰¾åˆ°ç°æœ‰èŠå¤©ï¼Œåœ¨æœ€åæ·»åŠ æ–°æ¶ˆæ¯
              const insertPosition = findInsertPositionForChat(currentContent, chatTag, tagIndex);
              const beforeInsert = currentContent.substring(0, insertPosition);
              const afterInsert = currentContent.substring(insertPosition);

              currentContent = beforeInsert + messageString + '\n' + afterInsert;
            } else {
              // æ²¡æœ‰æ‰¾åˆ°ç°æœ‰èŠå¤©ï¼Œåœ¨æœ«å°¾æ·»åŠ æ–°çš„èŠå¤©éƒ¨åˆ†
              const yujianMatch = currentContent.match(/<é±¼é›å°ç¬º>([\s\S]*?)<\/é±¼é›å°ç¬º>/);
              if (yujianMatch) {
                const beforeClosing = currentContent.substring(0, currentContent.lastIndexOf('</é±¼é›å°ç¬º>'));
                const afterClosing = '</é±¼é›å°ç¬º>';
                currentContent = beforeClosing + '\n\n' + chatTag + '\n' + messageString + '\n' + afterClosing;
              } else {
                currentContent += `\n${chatTag}\n${messageString}`;
              }
            }
          }
        }

        // ç¡®ä¿å†…å®¹æ ¼å¼æ­£ç¡®ï¼ŒåŒ…å«å®Œæ•´çš„æ ‡ç­¾
        if (!currentContent.includes('<é±¼é›å°ç¬º>')) {
          currentContent = `<é±¼é›å°ç¬º>\n${currentContent}\n</é±¼é›å°ç¬º>`;
        }
        if (!currentContent.includes('</é±¼é›å°ç¬º>')) {
          currentContent = currentContent.replace('</é±¼é›å°ç¬º>', '') + '\n</é±¼é›å°ç¬º>';
        }

        // æ›´æ–°æ•°æ®æº
        dataSource.textContent = currentContent;

        // ä½¿ç”¨SillyTavernçš„æ–¹å¼ä¿å­˜æ›´æ–°
        if (typeof setChatMessages === 'function') {
          const currentId = typeof getCurrentMessageId === 'function' ? getCurrentMessageId() : 0;
          await setChatMessages([{ message_id: currentId, message: currentContent }], { refresh: 'none' });
        }

        // æ›´æ–°å…¨å±€å˜é‡
        lastDataSourceContent = currentContent;
      }

      // ç¡®ä¿ç”¨æˆ·æ¶ˆæ¯å·²ç»ä¿å­˜åˆ°æ•°æ®æº
      async function ensureUserMessageSaved(userMessageData, currentContact) {
        const dataSource = document.getElementById('data-source');
        if (!dataSource) return;

        // æ„å»ºç”¨æˆ·æ¶ˆæ¯çš„æ ¼å¼
        const userMessageFormat = `[{{user}}|${userMessageData.text}|${userMessageData.time}]`;

        // æ£€æŸ¥æ•°æ®æºæ˜¯å¦åŒ…å«è¿™æ¡ç”¨æˆ·æ¶ˆæ¯
        const currentContent = dataSource.textContent;
        if (currentContent.includes(userMessageFormat)) {
          // ç”¨æˆ·æ¶ˆæ¯å·²ç»å­˜åœ¨ï¼Œæ— éœ€é‡å¤ä¿å­˜
          return;
        }

        // å¦‚æœç”¨æˆ·æ¶ˆæ¯ä¸å­˜åœ¨ï¼Œé‡æ–°ä¿å­˜
        try {
          await saveMessagesToSillyTavern([userMessageData], currentContact);

          // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿ä¿å­˜å®Œæˆ
          await new Promise(resolve => setTimeout(resolve, 50));
        } catch (error) {
          // é™é»˜å¤„ç†é”™è¯¯
        }
      }

      // ä½¿ç”¨SillyTavernçš„æ–¹å¼ä¿å­˜æ¶ˆæ¯åˆ°åŸå§‹æ¥¼å±‚
      async function saveMessagesToSillyTavern(newMessages, currentContact) {
        if (!newMessages || newMessages.length === 0) return;

        // æ„å»ºæ–°æ¶ˆæ¯å­—ç¬¦ä¸²
        const formattedMessages = newMessages.map(msg => {
          const senderName = msg.sender === CURRENT_USER_ID ? '{{user}}' : msg.sender;
          return `[${senderName}|${msg.text}|${msg.time}]`;
        });

        const formattedMessage = '\n' + formattedMessages.join('\n');

        // è·å–å½“å‰æ¶ˆæ¯IDå’Œå†…å®¹
        const currentId = typeof getCurrentMessageId === 'function' ? getCurrentMessageId() : 0;
        const latestText =
          typeof getChatMessages === 'function'
            ? getChatMessages(currentId)[0]?.message || '<é±¼é›å°ç¬º>\n</é±¼é›å°ç¬º>'
            : document.getElementById('data-source')?.textContent || '<é±¼é›å°ç¬º>\n</é±¼é›å°ç¬º>';

        // æå–<é±¼é›å°ç¬º>æ ‡ç­¾å†…çš„å†…å®¹
        const yujianMatch = latestText.match(/<é±¼é›å°ç¬º>([\s\S]*?)<\/é±¼é›å°ç¬º>/);
        let yujianContent = yujianMatch ? yujianMatch[1] : latestText;

        // ç¡®å®šèŠå¤©æ ‡ç­¾ - æ ¹æ®èŠå¤©ç±»å‹ç”Ÿæˆæ­£ç¡®çš„æ ‡ç­¾
        const isGroupChat = currentContact.id.startsWith('group_');
        let chatTag;

        if (isGroupChat) {
          chatTag = `[å¤šäººå°ç¬º:${currentContact.name}]`;
        } else {
          chatTag = `[{{user}}å’Œ${currentContact.name}çš„ç§å¯†å°ç¬º]`;
        }

        let newYujianContent;
        const blockStartIndex = yujianContent.indexOf(chatTag);

        if (blockStartIndex === -1) {
          // æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„èŠå¤©éƒ¨åˆ†ï¼Œåˆ›å»ºæ–°çš„
          const separator = yujianContent.trim() === '' ? '' : '\n\n';
          newYujianContent = yujianContent.trim() + separator + chatTag + formattedMessage;
        } else {
          // æ‰¾åˆ°äº†å¯¹åº”çš„èŠå¤©éƒ¨åˆ†ï¼Œåœ¨è¯¥éƒ¨åˆ†çš„æœ«å°¾è¿½åŠ æ–°æ¶ˆæ¯
          const searchStartIndex = blockStartIndex + chatTag.length;

          // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªèŠå¤©éƒ¨åˆ†çš„å¼€å§‹ä½ç½®
          const nextChatPatterns = [
            '\n[{{user}}å’Œ', // ç”¨æˆ·å¼€å¤´çš„ç§èŠ
            '\n[å¤šäººå°ç¬º:', // ç¾¤èŠ
            '\n</é±¼é›å°ç¬º>', // ç»“æŸæ ‡ç­¾
          ];

          let nextSectionIndex = yujianContent.length; // é»˜è®¤åˆ°æ–‡æ¡£æœ«å°¾

          // æ‰¾åˆ°æœ€è¿‘çš„ä¸‹ä¸€ä¸ªéƒ¨åˆ†
          for (const pattern of nextChatPatterns) {
            const index = yujianContent.indexOf(pattern, searchStartIndex);
            if (index !== -1 && index < nextSectionIndex) {
              nextSectionIndex = index;
            }
          }

          // è¿˜éœ€è¦æŸ¥æ‰¾å…¶ä»–äººå¼€å¤´çš„ç§èŠæ ¼å¼ï¼Œå¦‚ [é¡¾æ€€ç‘¾å’Œ{{user}}çš„ç§å¯†å°ç¬º]
          const otherPrivateChatRegex = /\n\[[^[]+å’Œ{{user}}çš„ç§å¯†å°ç¬º\]/g;
          otherPrivateChatRegex.lastIndex = searchStartIndex;
          const otherPrivateMatch = otherPrivateChatRegex.exec(yujianContent);
          if (otherPrivateMatch && otherPrivateMatch.index < nextSectionIndex) {
            nextSectionIndex = otherPrivateMatch.index;
          }

          // åœ¨å½“å‰èŠå¤©éƒ¨åˆ†çš„æœ«å°¾æ’å…¥æ–°æ¶ˆæ¯
          const textBefore = yujianContent.substring(0, nextSectionIndex);
          const textAfter = yujianContent.substring(nextSectionIndex);
          newYujianContent = textBefore.trimEnd() + formattedMessage + textAfter;
        }

        const updatedText = `<é±¼é›å°ç¬º>\n${newYujianContent.trim()}\n</é±¼é›å°ç¬º>`;

        // å…ˆæ›´æ–°DOMä¸­çš„æ•°æ®æº
        const dataSource = document.getElementById('data-source');
        if (dataSource) {
          dataSource.textContent = updatedText;
        }

        // ä½¿ç”¨SillyTavernçš„setChatMessageså‡½æ•°æ›´æ–°
        if (typeof setChatMessages === 'function') {
          await setChatMessages([{ message_id: currentId, message: updatedText }], { refresh: 'none' });
        }

        // æ›´æ–°å…¨å±€å˜é‡å¹¶è§¦å‘æ•°æ®æºå˜åŒ–å¤„ç†
        lastDataSourceContent = updatedText;

        // è§¦å‘æ•°æ®æºå˜åŒ–å¤„ç†ï¼Œç¡®ä¿ä¸»é¡µé¢èƒ½æ­£ç¡®æ˜¾ç¤º
        setTimeout(() => {
          if (typeof handleDataSourceChange === 'function') {
            handleDataSourceChange();
          }
        }, 10);

        // æ›´æ–°å…¨å±€å˜é‡
        lastDataSourceContent = updatedText;
      }

      // ç›´æ¥æ›´æ–°æ•°æ®æºDOMï¼Œè§¦å‘SillyTavernè‡ªåŠ¨ä¿å­˜
      function updateDataSource(newData) {
        const dataSource = document.getElementById('data-source');
        if (dataSource) {
          // ä¿å­˜æ—§å†…å®¹
          const oldContent = dataSource.textContent;

          // ç›´æ¥æ›´æ–°æ•°æ®æºå†…å®¹
          dataSource.textContent = newData;

          // æ›´æ–°å…¨å±€å˜é‡ï¼Œç¡®ä¿ä¸‹æ¬¡æ£€æµ‹æ—¶èƒ½è¯†åˆ«å˜åŒ–
          lastDataSourceContent = newData;

          // è§¦å‘å¤šç§å¯èƒ½çš„DOMå˜åŒ–äº‹ä»¶
          try {
            // ç°ä»£æµè§ˆå™¨äº‹ä»¶
            const inputEvent = new Event('input', { bubbles: true });
            dataSource.dispatchEvent(inputEvent);

            const changeEvent = new Event('change', { bubbles: true });
            dataSource.dispatchEvent(changeEvent);

            // è‡ªå®šä¹‰äº‹ä»¶
            const customEvent = new CustomEvent('dataSourceUpdated', {
              detail: { oldContent, newContent: newData },
              bubbles: true,
            });
            dataSource.dispatchEvent(customEvent);
          } catch (e) {
            // é™é»˜å¤„ç†é”™è¯¯
          }

          // å¼ºåˆ¶è§¦å‘ç°æœ‰çš„MutationObserver
          setTimeout(() => {
            if (typeof handleDataSourceChange === 'function') {
              handleDataSourceChange();
            }
          }, 10);
        }
      }

      async function sendMessage() {
        const messageInput = document.getElementById('messageInput');
        if (!messageInput || !currentContact) return;

        const content = messageInput.value.trim();
        if (!content) {
          alert('è¯·åœ¨ç¬ºä¸­å†™ä¸‹äº›ä»€ä¹ˆã€‚');
          return;
        }

        const currentTime = getCurrentTime();
        const messageData = { text: content, sender: CURRENT_USER_ID, time: currentTime };

        if (!tempMessages[currentContact.id]) {
          tempMessages[currentContact.id] = [];
        }
        tempMessages[currentContact.id].push(messageData);

        // ä½¿ç”¨SillyTavernçš„æ–¹å¼ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ°åŸå§‹æ¥¼å±‚
        try {
          await saveMessagesToSillyTavern([messageData], currentContact);

          // ç¡®ä¿ç”¨æˆ·æ¶ˆæ¯ä¿å­˜å®Œæˆåå†æ›´æ–°å…¨å±€çŠ¶æ€
          lastDataSourceContent = document.getElementById('data-source').textContent;
        } catch (error) {
          // é™é»˜å¤„ç†é”™è¯¯ï¼Œä¸å½±å“ç•Œé¢æ˜¾ç¤º
        }

        const recipient = currentContact.name;
        const isGroupChat = currentContact.id.startsWith('group_');

        // æ¸…ç©ºè¾“å…¥æ¡†
        messageInput.value = '';

        // æ„å»ºç®€å•çš„ç”¨æˆ·æ¶ˆæ¯æ ¼å¼
        const buildUserMessage = () => {
          const senderName = '{{user}}';
          return `[${senderName}|${content}|${currentTime}]`;
        };

        // è°ƒç”¨generateè·å–AIæ–°å›å¤ï¼Œåªå‘é€ç”¨æˆ·çš„å½“å‰æ¶ˆæ¯
        if (typeof generate === 'function') {
          const userMessage = buildUserMessage();

          // æ·»åŠ å°å»¶è¿Ÿç¡®ä¿ç”¨æˆ·æ¶ˆæ¯å®Œå…¨ä¿å­˜
          await new Promise(resolve => setTimeout(resolve, 100));

          // æ„å»ºæ ¼å¼è¦æ±‚æç¤º
          const contactName = currentContact.name;
          const userReplyText = `å›å¤${contactName}çš„å°ç¬º: ${content}`;

          const formatInstruction = `

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¦æ±‚ç”Ÿæˆå›å¤ï¼Œå†…å®¹å¿…é¡»åŒ…è£¹åœ¨<é±¼é›å°ç¬º></é±¼é›å°ç¬º>æ ‡ç­¾å†…ï¼Œä¾‹å¦‚ï¼š

<é±¼é›å°ç¬º>
[{{user}}å’Œxxxçš„ç§å¯†å°ç¬º]
å¯¹æ–¹å°ç¬ºçš„æ ¼å¼ä¸ºï¼š[xxx|{{å°ç¬ºå†…å®¹}}|{{å°ç¬ºæ—¶é—´}}]

[å¤šäººå°ç¬º:æ¡ç‘¾æ€€ç‘œ]
å°ç¬ºçš„æ ¼å¼ä¸ºï¼š[xxx|{{å°ç¬ºå†…å®¹}}|{{å°ç¬ºæ—¶é—´}}]
</é±¼é›å°ç¬º>

é‡è¦æç¤ºï¼š1.å¦‚æœ{{user}}åªå›å¤å…¶ä¸­ä¸€ä¸ªäººæˆ–è€…å¤šäººå°ç¬ºçš„å†…å®¹ï¼Œé‚£ä¹ˆåªéœ€è¦ç”Ÿæˆ{{user}}å›å¤çš„é‚£ä¸ªå°ç¬ºï¼Œå…¶ä½™ä¸¤ä¸ªå°ç¬ºçš„å†…å®¹å¯ä»¥ä¸ç”¨ç”Ÿæˆï¼Œç›´åˆ°{{user}}é€‰æ‹©å›å¤ã€‚2.å¦‚æœå›å¤å¤šäººå°ç¬ºï¼Œæœ‰æ¦‚ç‡ä¼šè§¦å‘è§’è‰²ä¸»åŠ¨å‘é€ç§èŠå°ç¬ºã€‚3.ç¦æ­¢é‡å¤ç”Ÿæˆå°ç¬ºå†…å®¹ï¼Œåªéœ€è¦ç”Ÿæˆæ–°çš„å›å¤å†…å®¹ï¼

ç”¨æˆ·æ¶ˆæ¯ï¼š${userReplyText}`;

          generate({
            user_input: formatInstruction,
            should_stream: false,
          })
            .then(async res => {
              // å¤„ç†AIå›å¤ - è·å–åŸå§‹å›å¤æ–‡æœ¬
              let aiReplyText = '';
              if (res && res.response) {
                aiReplyText = res.response;
              } else if (typeof res === 'string') {
                aiReplyText = res;
              } else {
                return;
              }

              // å¤„ç†AIå›å¤ä¸­çš„æ‰€æœ‰èŠå¤©å†…å®¹
              const allChatMessages = processAllChatsInAIReply(aiReplyText);

              if (Object.keys(allChatMessages).length === 0) {
                return;
              }

              // ç¡®ä¿åœ¨ä¿å­˜AIå›å¤å‰ï¼Œæ•°æ®æºåŒ…å«æœ€æ–°çš„ç”¨æˆ·æ¶ˆæ¯
              await ensureUserMessageSaved(messageData, currentContact);

              // ä¿å­˜æ‰€æœ‰èŠå¤©çš„æ¶ˆæ¯åˆ°æ•°æ®æº
              await saveAllChatsToDataSource(allChatMessages);

              // ä¸éœ€è¦æ‰‹åŠ¨æ·»åŠ åˆ°ç•Œé¢ï¼Œæ•°æ®æºæ›´æ–°åä¼šè‡ªåŠ¨åˆ·æ–°æ˜¾ç¤º
            })
            .catch(error => {
              alert('AIå›å¤ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚');
            });
        } else if (typeof triggerSlash === 'function') {
          // å¦‚æœæ²¡æœ‰generateå‡½æ•°ï¼Œå›é€€åˆ°åŸæœ‰çš„triggerSlashæ–¹å¼ï¼Œä½†åªå‘é€ç”¨æˆ·æ¶ˆæ¯
          const userMessage = buildUserMessage();
          triggerSlash(`/send ${userMessage}|/trigger`);
        } else {
          alert('æ— æ³•å‘é€å°ç¬ºï¼Œå½“å‰ç¯å¢ƒä¸æ”¯æŒæ­¤æ“ä½œã€‚');
        }
      }

      function backToContacts() {
        const chatPage = document.getElementById('chatPage');
        if (chatPage) chatPage.classList.remove('active');
        currentContact = null;
      }

      function setRandomContent() {
        const randomImage = document.getElementById('randomImage');
        const randomQuote = document.getElementById('randomQuote');
        const imageUrls = [
          'https://files.catbox.moe/ij39sg.jpeg',
          'https://files.catbox.moe/ybt41t.jpeg',
          'https://files.catbox.moe/q6kp1e.jpeg',
          'https://files.catbox.moe/xdfyfy.jpeg',
          'https://files.catbox.moe/b3sunb.jpeg',
          'https://files.catbox.moe/54ee4g.jpeg',
          'https://files.catbox.moe/pby9iu.jpeg',
          'https://files.catbox.moe/88hf06.jpeg',
        ];
        if (randomImage) {
          const randomImageIndex = Math.floor(Math.random() * imageUrls.length);
          randomImage.src = imageUrls[randomImageIndex];
        }
        if (randomQuote) {
          const randomQuoteIndex = Math.floor(Math.random() * quotes.length);
          let quoteText = quotes[randomQuoteIndex];
          let userName = '{{user}}';
          randomQuote.textContent = quoteText.replace(/ç‘¾ï¼š|ç‘œï¼š/g, '').replace('{{user}}', userName);
          if (quotes[randomQuoteIndex].startsWith('ç‘¾ï¼š')) {
            randomQuote.innerHTML =
              `<span style="font-weight:bold; color:var(--accent);">ç‘¾ï¼š</span>` + randomQuote.textContent;
          } else if (quotes[randomQuoteIndex].startsWith('ç‘œï¼š')) {
            randomQuote.innerHTML =
              `<span style="font-weight:bold; color:var(--primary);">ç‘œï¼š</span>` + randomQuote.textContent;
          }
        }
      }

      function handleDataSourceChange() {
        const dataSource = document.getElementById('data-source');
        if (!dataSource) return;

        const currentContent = dataSource.textContent;

        if (currentContent !== lastDataSourceContent) {
          lastDataSourceContent = currentContent;

          // é‡æ–°è§£ææ•°æ®æº
          const newContactsData = parseDataSource(true);

          // æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ¶ˆæ¯
          const hasNewMessages = checkForNewMessages(contactsData, newContactsData);

          // æ›´æ–°è”ç³»äººæ•°æ®
          contactsData = newContactsData;

          // é‡æ–°åˆå§‹åŒ–è”ç³»äººåˆ—è¡¨
          initContacts();

          // å¦‚æœå½“å‰åœ¨èŠå¤©é¡µé¢ï¼Œéœ€è¦æ›´æ–°å½“å‰èŠå¤©çš„æ¶ˆæ¯
          if (currentContact) {
            updateCurrentChatIfNeeded();
          }
        }
      }

      // æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ¶ˆæ¯
      function checkForNewMessages(oldContacts, newContacts) {
        let hasNew = false;

        newContacts.forEach(newContact => {
          const oldContact = oldContacts.find(c => c.id === newContact.id);

          if (oldContact) {
            // æ¯”è¾ƒæœ€åä¸€æ¡æ¶ˆæ¯
            const oldLastMessage = oldContact.lastMessage;
            const newLastMessage = newContact.lastMessage;

            if (
              newLastMessage.text &&
              newLastMessage.sender !== CURRENT_USER_ID &&
              JSON.stringify(oldLastMessage) !== JSON.stringify(newLastMessage)
            ) {
              hasNew = true;

              // è§¦å‘æ–°æ¶ˆæ¯å¼¹çª—
              const isCurrentContact = currentContact && currentContact.id === newContact.id;
              const chatInfo = { name: newContact.name, isGroup: newContact.id.startsWith('group_') };
              showMessageNotification(newLastMessage.sender, newLastMessage.text, isCurrentContact, chatInfo);
            }
          } else if (newContact.lastMessage.text && newContact.lastMessage.sender !== CURRENT_USER_ID) {
            // æ–°çš„è”ç³»äººä¸”æœ‰æ¶ˆæ¯
            hasNew = true;

            // è§¦å‘æ–°æ¶ˆæ¯å¼¹çª—
            const isCurrentContact = currentContact && currentContact.id === newContact.id;
            const chatInfo = { name: newContact.name, isGroup: newContact.id.startsWith('group_') };
            showMessageNotification(
              newContact.lastMessage.sender,
              newContact.lastMessage.text,
              isCurrentContact,
              chatInfo,
            );
          }
        });

        return hasNew;
      }

      // å¦‚æœå½“å‰åœ¨èŠå¤©é¡µé¢ï¼Œæ›´æ–°èŠå¤©å†…å®¹
      function updateCurrentChatIfNeeded() {
        if (!currentContact) return;

        // æ‰¾åˆ°æ›´æ–°åçš„å½“å‰è”ç³»äººæ•°æ®
        const updatedContact = contactsData.find(c => c.id === currentContact.id);
        if (!updatedContact) return;

        // æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ¶ˆæ¯éœ€è¦æ·»åŠ åˆ°å½“å‰èŠå¤©
        const currentMessages = currentContact.messages || [];
        const updatedMessages = updatedContact.messages || [];

        if (updatedMessages.length > currentMessages.length) {
          // æœ‰æ–°æ¶ˆæ¯ï¼Œæ·»åŠ åˆ°å½“å‰èŠå¤©ç•Œé¢
          const newMessages = updatedMessages.slice(currentMessages.length);
          newMessages.forEach(message => {
            addMessageToChat(message.text, message.sender === CURRENT_USER_ID, message.time, message.sender);
          });

          // æ›´æ–°å½“å‰è”ç³»äººçš„æ¶ˆæ¯æ•°æ®
          currentContact.messages = updatedMessages;
        }
      }

      // å¼ºåˆ¶åˆ·æ–°ä¸»é¡µé¢çš„è”ç³»äººåˆ—è¡¨å’Œæ¶ˆæ¯çŠ¶æ€
      function forceRefreshMainPage() {
        // é‡æ–°è§£ææ•°æ®æº
        const newContactsData = parseDataSource(true);

        if (newContactsData.length === 0) {
          // å¦‚æœè§£æç»“æœä¸ºç©ºï¼Œå¯èƒ½æ˜¯æ•°æ®æºæœ‰é—®é¢˜ï¼Œç¨åé‡è¯•
          setTimeout(() => {
            forceRefreshMainPage();
          }, 100);
          return;
        }

        // æ›´æ–°è”ç³»äººæ•°æ®
        contactsData = newContactsData;

        // é‡æ–°åˆå§‹åŒ–è”ç³»äººåˆ—è¡¨
        initContacts();

        // å¦‚æœå½“å‰åœ¨èŠå¤©é¡µé¢ï¼Œä¹Ÿéœ€è¦æ›´æ–°
        if (currentContact) {
          updateCurrentChatIfNeeded();
        }
      }

      // ç›‘å¬æ•°æ®æºçš„ç›´æ¥å˜åŒ–ï¼ˆç”¨äºè°ƒè¯•å’Œå¼ºåˆ¶æ›´æ–°ï¼‰
      function setupDataSourceMonitoring() {
        const dataSource = document.getElementById('data-source');
        if (!dataSource) return;

        // åˆ›å»ºä¸€ä¸ªæ›´æ•æ„Ÿçš„è§‚å¯Ÿå™¨
        const sensitiveObserver = new MutationObserver(mutations => {
          let shouldUpdate = false;

          mutations.forEach(mutation => {
            if (mutation.type === 'childList' || mutation.type === 'characterData') {
              shouldUpdate = true;
            }
          });

          if (shouldUpdate) {
            // å»¶è¿Ÿä¸€ç‚¹æ‰§è¡Œï¼Œç¡®ä¿æ•°æ®æºå®Œå…¨æ›´æ–°
            setTimeout(() => {
              handleDataSourceChange();
            }, 50);
          }
        });

        sensitiveObserver.observe(dataSource, {
          childList: true,
          characterData: true,
          subtree: true,
          characterDataOldValue: true,
        });
      }

      // å…¨å±€åˆ·æ–°å‡½æ•°ï¼Œå¯ä»¥ä»å¤–éƒ¨è°ƒç”¨
      window.refreshYujianMainPage = function () {
        forceRefreshMainPage();
      };

      // æ–°æ¶ˆæ¯å¼¹çª—åŠŸèƒ½
      let notificationTimeout = null;
      let notificationQueue = [];
      let isShowingNotification = false;

      function showMessageNotification(senderName, messageText, isCurrentContact = false, chatInfo = null) {
        // æ·»åŠ åˆ°é˜Ÿåˆ—
        notificationQueue.push({ senderName, messageText, isCurrentContact, chatInfo });

        // å¦‚æœå½“å‰æ²¡æœ‰æ˜¾ç¤ºå¼¹çª—ï¼Œå¼€å§‹å¤„ç†é˜Ÿåˆ—
        if (!isShowingNotification) {
          processNotificationQueue();
        }
      }

      function processNotificationQueue() {
        if (notificationQueue.length === 0) {
          isShowingNotification = false;
          return;
        }

        isShowingNotification = true;
        const { senderName, messageText, isCurrentContact, chatInfo } = notificationQueue.shift();

        displayNotification(senderName, messageText, isCurrentContact, chatInfo);
      }

      function displayNotification(senderName, messageText, isCurrentContact = false, chatInfo = null) {
        const notification = document.getElementById('messageNotification');
        const content = document.getElementById('notificationContent');

        // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
        if (notificationTimeout) {
          clearTimeout(notificationTimeout);
        }

        if (isCurrentContact) {
          // å½“å‰è”ç³»äººçš„æ¶ˆæ¯ - ç®€å•æç¤º
          notification.className = 'message-notification current-contact';
          content.innerHTML = `
            <div class="notification-header">
              æ–°æ¶ˆæ¯
              <button class="notification-close" onclick="hideMessageNotification()">Ã—</button>
            </div>
            <div class="notification-body">
              <div class="notification-current-text">ğŸ¾ä»–çš„æ–°ä¿¡æ¯æ¥å•¦~</div>
            </div>
          `;
        } else {
          // å…¶ä»–è”ç³»äººçš„æ¶ˆæ¯ - è¯¦ç»†ä¿¡æ¯
          notification.className = 'message-notification';

          let displayName = senderName;
          let avatarUrl = SENDER_AVATARS[senderName] || '';
          let displayText = messageText;

          // å¦‚æœæ˜¯ç¾¤èŠæ¶ˆæ¯ï¼Œæ˜¾ç¤ºç¾¤èŠä¿¡æ¯
          if (chatInfo && chatInfo.isGroup) {
            displayName = chatInfo.name; // ç¾¤èŠåå­—
            avatarUrl = 'https://files.catbox.moe/aeea20.jpg'; // ç¾¤èŠå¤´åƒ
            displayText = `${senderName}: ${messageText}`; // æ˜¾ç¤ºå‘é€è€…: æ¶ˆæ¯å†…å®¹
          }

          const truncatedText = displayText.length > 45 ? displayText.substring(0, 45) + '...' : displayText;

          // å¦‚æœæ²¡æœ‰å¤´åƒï¼Œä½¿ç”¨åå­—é¦–å­—ä½œä¸ºå¤´åƒ
          const avatarContent = avatarUrl
            ? `<img src="${avatarUrl}" alt="${displayName}" class="notification-avatar">`
            : `<div class="notification-avatar" style="background: linear-gradient(45deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.2rem;">${displayName.charAt(
                0,
              )}</div>`;

          content.innerHTML = `
            <div class="notification-header">
              æ–°æ¶ˆæ¯
              <button class="notification-close" onclick="hideMessageNotification()">Ã—</button>
            </div>
            <div class="notification-body">
              ${avatarContent}
              <div class="notification-content">
                <div class="notification-name">${displayName}</div>
                <div class="notification-text">${truncatedText}</div>
              </div>
            </div>
          `;
        }

        // æ˜¾ç¤ºå¼¹çª—
        notification.classList.add('show');

        // 3ç§’åè‡ªåŠ¨éšè—å¹¶å¤„ç†ä¸‹ä¸€ä¸ª
        notificationTimeout = setTimeout(() => {
          hideMessageNotification();
        }, 3000);
      }

      function hideMessageNotification() {
        const notification = document.getElementById('messageNotification');
        notification.classList.remove('show');

        if (notificationTimeout) {
          clearTimeout(notificationTimeout);
          notificationTimeout = null;
        }

        // å»¶è¿Ÿä¸€ç‚¹åå¤„ç†ä¸‹ä¸€ä¸ªå¼¹çª—ï¼Œè®©åŠ¨ç”»å®Œæˆ
        setTimeout(() => {
          processNotificationQueue();
        }, 400);
      }

      // åˆå§‹åŒ–å¼¹çª—å…³é—­æŒ‰é’®
      function initNotificationEvents() {
        const closeBtn = document.getElementById('notificationClose');
        const notification = document.getElementById('messageNotification');

        if (closeBtn) {
          closeBtn.addEventListener('click', hideMessageNotification);
        }

        // ç‚¹å‡»å¼¹çª—ä¹Ÿå¯ä»¥å…³é—­
        if (notification) {
          notification.addEventListener('click', hideMessageNotification);
        }
      }

      // å…¨å±€è·å–å½“å‰çŠ¶æ€çš„å‡½æ•°ï¼Œç”¨äºè°ƒè¯•
      window.getYujianStatus = function () {
        return {
          contactsData: contactsData,
          currentContact: currentContact,
          tempMessages: tempMessages,
          lastDataSourceContent: lastDataSourceContent,
        };
      };

      document.addEventListener('DOMContentLoaded', () => {
        const savedThemeIndex = localStorage.getItem('chatThemeIndex');
        if (savedThemeIndex !== null) {
          currentThemeIndex = parseInt(savedThemeIndex, 10);
        }
        applyTheme(themes[currentThemeIndex]);

        const themeToggleButton = document.getElementById('theme-toggle-button');
        if (themeToggleButton) {
          themeToggleButton.addEventListener('click', () => {
            currentThemeIndex = (currentThemeIndex + 1) % themes.length;
            applyTheme(themes[currentThemeIndex]);
            localStorage.setItem('chatThemeIndex', currentThemeIndex);
          });
        }

        try {
          previousMessages = JSON.parse(localStorage.getItem('previousMessages')) || {};
        } catch (e) {
          previousMessages = {};
        }

        const sendButton = document.getElementById('sendButton');
        const messageInput = document.getElementById('messageInput');
        const backButton = document.getElementById('backButton');
        const randomImageContainer = document.getElementById('randomImageContainer');

        const dataSource = document.getElementById('data-source');
        const observer = new MutationObserver(handleDataSourceChange);

        if (dataSource) {
          observer.observe(dataSource, { childList: true, characterData: true, subtree: true });
        }

        // è®¾ç½®é¢å¤–çš„æ•°æ®æºç›‘å¬
        setupDataSourceMonitoring();

        lastDataSourceContent = dataSource ? dataSource.textContent : '';
        contactsData = parseDataSource();
        initContacts();
        setRandomContent();
        initNotificationEvents();

        if (sendButton) sendButton.addEventListener('click', sendMessage);
        if (messageInput)
          messageInput.addEventListener('keypress', e => {
            if (e.key === 'Enter') {
              e.preventDefault();
              sendMessage();
            }
          });
        if (backButton) backButton.addEventListener('click', backToContacts);
        if (randomImageContainer) randomImageContainer.addEventListener('click', setRandomContent);
      });

      // *******************ä¸è¦å†ç”¨é¹¤å”¯çš„ä»£ç äº†å¥½å—å¥½çš„*************
    </script>
  </body>
</html>
```
